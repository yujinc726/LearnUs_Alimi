<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LearnUs Alimi</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    :root {
      --primary-gradient-start: #4e54c8;
      --primary-gradient-end: #8f94fb;
    }

    body {
      background: linear-gradient(135deg, #eef2ff 0%, #fafcff 100%);
      font-family: 'Poppins', 'Noto Sans KR', sans-serif;
    }

    h1 {
      font-weight: 700;
      background: linear-gradient(90deg, var(--primary-gradient-start), var(--primary-gradient-end));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      max-width: 900px;
      margin: 0 auto 1.5rem auto;
      padding-left: 0.75rem; /* slight indent */
    }

    /* Login card */
    #login-form {
      max-width: 600px;
      margin: 0 auto 2rem;
      background: #fff;
      border-radius: 1rem;
      padding: 2rem;
      box-shadow: 0 0.75rem 1.5rem rgba(0, 0, 0, 0.1);
    }

    /* Login form elements */
    #login-form .input-group-text {
      background: transparent;
      border-right: 0;
    }

    #login-form .form-control {
      border-left: 0;
      box-shadow: none !important;
    }

    #login-form .btn-primary {
      background: linear-gradient(90deg, var(--primary-gradient-start), var(--primary-gradient-end));
      border: none;
      font-weight: 600;
    }

    #login-form .btn-primary:hover {
      opacity: 0.9;
    }

    /* Footer */
    #footer {
      position: fixed;
      bottom: 15px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.875rem;
      color: #6c757d;
      text-align: center;
    }

    /* Course selector & Todo wrapper */
    #course-section,
    #todo-section {
      max-width: 900px;
      margin: 0 auto;
    }

    #course-section {
      background: #fff;
      border-radius: 1rem;
      padding: 1.5rem;
      box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.05);
    }

    /* Todo lists styling */
    #todo-section .col-12 {
      margin-bottom: 3.5rem; /* increased gap */
    }

    #todo-section h4 {
      font-weight: 600;
      margin-bottom: 0.75rem;
    }

    #todo-section ul.list-group {
      border: 0;
      border-radius: 0.75rem;
      overflow: hidden;
      box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.05);
    }

    /* Calendar card */
    #calendar {
      max-width: 900px;
      margin: 40px auto;
      background: #fff;
      border-radius: 1rem;
      padding: 1rem;
      box-shadow: 0 0.75rem 1.5rem rgba(0, 0, 0, 0.1);
    }

    #loading-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255,255,255,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1050;
      visibility: hidden;
    }
  </style>
</head>
<body class="py-4">
  <h1 class="mb-4">LearnUs Alimi</h1>

  <!-- Login form -->
  <form id="login-form" class="mb-4">
    <div class="input-group mb-3">
      <span class="input-group-text"><i class="fa-solid fa-user"></i></span>
      <input type="text" id="username" class="form-control" placeholder="Student ID" required />
    </div>
    <div class="input-group mb-3">
      <span class="input-group-text"><i class="fa-solid fa-lock"></i></span>
      <input type="password" id="password" class="form-control" placeholder="Password" required />
    </div>
    <button type="submit" class="btn btn-primary w-100">Login</button>
    <div id="login-error" class="text-danger mt-3 text-center"></div>
  </form>

  <!-- Course selector -->
  <div id="course-section" class="d-none mb-4">
    <label for="course-select" class="form-label">강좌 선택</label>
    <select id="course-select" class="form-select" style="max-width: 400px"></select>
  </div>

  <!-- Todo Lists -->
  <div id="todo-section" class="d-none row mt-4">
    <div class="col-12 mb-3">
      <h4>시청해야 할 동영상</h4>
      <ul id="video-list" class="list-group"></ul>
    </div>
    <div class="col-12">
      <h4>제출해야 할 과제</h4>
      <ul id="assign-list" class="list-group"></ul>
    </div>
  </div>

  <!-- Calendar -->
  <div id="calendar" class="d-none"></div>

  <!-- Loading overlay -->
  <div id="loading-overlay">
    <div class="text-center">
      <div class="spinner-border text-primary" role="status" style="width: 4rem; height: 4rem;"></div>
      <p class="mt-3 fw-bold">로딩 중...</p>
    </div>
  </div>

  <!-- Footer -->
  <footer id="footer">
    Developed by Yujin Cha<br />
    대기과학과 화이팅!
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <script>
    const loginForm = document.getElementById('login-form');
    const courseSection = document.getElementById('course-section');
    const courseSelect = document.getElementById('course-select');
    const calendarEl = document.getElementById('calendar');
    const loginError = document.getElementById('login-error');
    let token = null;
    let calendar = null;

    function showLoading(show) {
      document.getElementById('loading-overlay').style.visibility = show ? 'visible' : 'hidden';
    }

    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      loginError.textContent = '';
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;
      try {
        showLoading(true);
        const res = await fetch('/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password }),
        });
        if (!res.ok) {
          const msg = await res.text();
          throw new Error(msg);
        }
        const data = await res.json();
        token = data.token;
        loginForm.classList.add('d-none');
        await loadAllEvents();
      } catch (err) {
        loginError.textContent = err.message || 'Login failed';
        showLoading(false);
      }
    });

    async function apiGet(path) {
      showLoading(true);
      const res = await fetch(path, { headers: { 'X-Auth-Token': token } });
      if (!res.ok) {
        showLoading(false);
        throw new Error(await res.text());
      }
      const data = await res.json();
      showLoading(false);
      return data;
    }

    async function loadAllEvents() {
      const data = await apiGet('/events');
      renderCalendar(data.calendar);
      renderTodos(data.videos, data.assignments);
    }

    function renderCalendar(events) {
      calendarEl.classList.remove('d-none');
      if (calendar) {
        calendar.removeAllEvents();
        calendar.addEventSource(events);
        return;
      }
      calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        height: 'auto',
        events,
        eventColor: '#3788d8',
        eventDidMount: function(info) {
          if (!info.event.extendedProps.completed) {
            // highlight not completed
            info.el.style.fontWeight = 'bold';
            if (info.event.extendedProps.type === 'assign') {
              info.el.style.backgroundColor = '#dc3545';
            }
          }
        }
      });
      calendar.render();
    }

    function renderTodos(videos, assigns) {
      const videoList = document.getElementById('video-list');
      const assignList = document.getElementById('assign-list');

      videoList.innerHTML = videos.length ? '' : '<li class="list-group-item">모두 완료!</li>';
      videos.forEach(v => {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        li.textContent = v.title;
        const badge = document.createElement('span');
        badge.className = 'badge bg-primary rounded-pill';
        badge.textContent = new Date(v.due).toLocaleString('ko-KR');
        li.appendChild(badge);
        videoList.appendChild(li);
      });

      assignList.innerHTML = assigns.length ? '' : '<li class="list-group-item">모두 완료!</li>';
      assigns.forEach(a => {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        li.textContent = a.title;
        const badge = document.createElement('span');
        badge.className = 'badge bg-danger rounded-pill';
        badge.textContent = new Date(a.due).toLocaleString('ko-KR');
        li.appendChild(badge);
        assignList.appendChild(li);
      });

      document.getElementById('todo-section').classList.remove('d-none');
    }
  </script>
</body>
</html> 